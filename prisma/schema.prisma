generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// Enums
enum ActivityType {
  INTERACTIVE
  REFLECTION
  UPLOAD
}

enum ModuleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum ProjectCategory {
  RESEARCH
  CREATIVE
  SOCIAL_IMPACT
  ENTREPRENEURIAL
  TECHNICAL
  LEADERSHIP
}

enum ProjectStatus {
  IDEATION
  PLANNING
  IN_PROGRESS
  PAUSED
  COMPLETED
  ABANDONED
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum DocumentType {
  PHOTO
  VIDEO
  PDF
  LINK
  OTHER
}

enum SessionCategory {
  ACADEMIC
  CAREER
  PERSONAL_DEV
  COLLEGE_PREP
  EMOTIONAL
  TECHNICAL
}

enum SessionMode {
  TEXT
  VOICE
}

enum MessageRole {
  USER
  ASSISTANT
}

enum QuestionCategory {
  HOMEWORK_HELP
  CONCEPT_CLARIFICATION
  CAREER_ADVICE
  STUDY_STRATEGY
  COLLEGE_APPS
  EMOTIONAL_SUPPORT
  PLATFORM_HELP
  OTHER
}


// User model - synced with Clerk
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String
  grade     Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  profile        Profile?
  activities     ActivityCompletion[]
  reflections    Reflection[]
  projects       Project[]
  moduleProgress ModuleProgress[]
  
  @@index([clerkId])
  @@index([email])
}

// User profile
model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio       String?
  avatarUrl String?
  
  // Onboarding data
  goals     Json?    // Array of goal strings from onboarding
  
  // Progress tracking
  moduleOneProgress Int @default(0) // 0-100
  overallProgress   Int @default(0) // 0-100
  
  // Discoveries from Module 1
  topValues    String[] // Array of top 5 values
  topStrengths String[] // Array of top 5 strengths
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Module model
model Module {
  id              String   @id @default(cuid())
  orderIndex      Int      @unique
  title           String
  description     String   @db.Text
  tagline         String?
  estimatedHours  Int
  icon            String?
  videoUrl        String?
  status          ModuleStatus @default(PUBLISHED)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  activities      Activity[]
  moduleProgress  ModuleProgress[]
  
  @@index([orderIndex])
  @@index([status])
}

// ModuleProgress model
model ModuleProgress {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId        String
  module          Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  status          ProgressStatus @default(NOT_STARTED)
  progressPercent Int      @default(0)
  
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}

// Activities in modules
model Activity {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String
  orderIndex  Int
  type        ActivityType
  
  // Module relationship
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  requiredForCompletion Boolean @default(true)
  
  estimatedMinutes Int
  content     Json? // Flexible content structure
  
  completions ActivityCompletion[]

  streak          Int      @default(0)
  longestStreak   Int      @default(0)
  lastStreakDate  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([orderIndex])
  @@index([moduleId])
}

// Track activity completion
model ActivityCompletion {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  completed  Boolean  @default(false)
  data       Json?    // Activity-specific response data
  timeSpent  Int?     // Seconds
  
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
}

// AI-powered reflections
model Reflection {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  prompt    String
  response  String   @db.Text
  aiInsight String?  @db.Text // AI-generated insight
  
  createdAt DateTime @default(now())
  
  @@index([userId])
}

// Projects
model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String   @db.Text
  category    ProjectCategory
  
  status      ProjectStatus @default(IDEATION)
  healthScore Int      @default(50)
  
  // AI-generated idea metadata
  ideaSource  Json?    // Original AI-generated idea
  
  // Goals and planning
  goals       Json?    // Array of SMART goals
  resources   Json?    // Resource planning data
  metrics     Json?    // Impact metrics
  
  startedAt   DateTime?
  targetCompletionAt DateTime?
  completedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  milestones  Milestone[]
  tasks       Task[]
  checkIns    ProjectCheckIn[]
  documents   ProjectDocument[]
  
  @@index([userId])
  @@index([status])
}

model Milestone {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  orderIndex  Int
  title       String
  description String?
  
  status      MilestoneStatus @default(NOT_STARTED)
  targetDate  DateTime?
  completedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
}

model Task {
  id            String   @id @default(cuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  estimatedHours Int?
  
  completed     Boolean  @default(false)
  completedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([projectId])
}

model ProjectCheckIn {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  accomplishments String   @db.Text
  challenges      String?  @db.Text
  learnings       String?  @db.Text
  nextSteps       String?  @db.Text
  
  hoursLogged     Int?
  moodRating      Int?     // 1-5 scale
  
  createdAt       DateTime @default(now())
  
  @@index([projectId])
}

model ProjectDocument {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type        DocumentType
  title       String
  url         String
  fileSize    Int?
  mimeType    String?
  
  createdAt   DateTime @default(now())
  
  @@index([projectId])
}

model LearningSession {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title           String?
  category        SessionCategory?
  mode            SessionMode @default(TEXT)
  
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  duration        Int?
  
  messages        LearningMessage[]
  
  // Analytics
  messageCount    Int @default(0)
  rating          Int?
  feedback        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([category])
}

model LearningMessage {
  id          String   @id @default(cuid())
  sessionId   String
  session     LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role        MessageRole
  content     String @db.Text
  category    QuestionCategory?
  
  // Voice specific (Phase 2)
  audioUrl    String?
  transcript  String? @db.Text
  
  // AI metadata
  modelUsed   String?
  tokens      Int?
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
}
